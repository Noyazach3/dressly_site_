@page "/add-item"
@inject HttpClient Http
@inject NavigationManager Navigation
@using ClassLibrary1.Models

<div class="container mt-5">
    <div class="card shadow-sm border-0">
        <div class="card-body text-end">

            <h2 class="card-title text-center mb-4">הוספת פריט לבוש</h2>

            @if (!isStep1Completed)
            {
                <h5 class="text-muted mb-4 text-center">שלב 1 מתוך 2: הזנת פרטי הפריט</h5>
                <EditForm Model="@clothingItem" OnValidSubmit="HandleStep1Submit">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="mb-3">
                        <label for="category" class="form-label">:בחר סוג פריט</label>
                        <InputSelect id="category" class="form-select" @bind-Value="clothingItem.Category">
                            <option value="">בחר...</option>
                            <option value="Shirt">חולצה</option>
                            <option value="Pants">מכנסיים</option>
                            <!-- הוסיפי קטגוריות נוספות -->
                        </InputSelect>
                        <ValidationMessage For="@(() => clothingItem.Category)" />
                    </div>

                    <div class="mb-3">
                        <label for="season" class="form-label">:בחר עונה</label>
                        <InputSelect id="season" class="form-select" @bind-Value="clothingItem.Season">
                            <option value="">בחר...</option>
                            <option value="Summer">קיץ</option>
                            <option value="Winter">חורף</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => clothingItem.Season)" />
                    </div>

                    <div class="mb-3">
                        <label for="usageType" class="form-label">:בחר סוג שימוש</label>
                        <InputSelect id="usageType" class="form-select" @bind-Value="clothingItem.UsageType">
                            <option value="">בחר...</option>
                            <option value="Casual">יום-יומי</option>
                            <option value="Festive">חגיגי</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => clothingItem.UsageType)" />
                    </div>

                    <div class="mb-3">
                        <label for="color" class="form-label">:בחר צבע</label>
                        <InputSelect id="color" class="form-select" @bind-Value="clothingItem.ColorName">
                            <option value="">בחר...</option>
                            <option value="Red">אדום</option>
                            <option value="Blue">כחול</option>
                            <!-- הוסיפי צבעים נוספים -->
                        </InputSelect>
                        <ValidationMessage For="@(() => clothingItem.ColorName)" />
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-pink btn-lg">המשך לשלב הבא</button>
                    </div>
                </EditForm>
            }
            else if (!isComplete)
            {
                <h5 class="text-muted mb-4 text-center">מעולה! עכשיו רק נותר להעלות תמונה של הפריט</h5>
                <div class="text-center">
                    <InputFile OnChange="HandleFileSelected" class="form-control mb-3" />
                    <button class="btn btn-pink" @onclick="HandleUploadImage">העלה תמונה</button>
                </div>
            }
            else
            {
                <div class="alert alert-success text-center mt-3">
                    <h5>✨ הפריט הוסף לארון בהצלחה!</h5>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .btn-pink {
        background-color: #ec87b8;
        border: none;
        color: white;
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        transition: all 0.3s ease-in-out;
    }

        .btn-pink:hover {
            background-color: #f69dc6;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(236, 135, 184, 0.3);
        }
</style>

@code {
    private ClothingItem clothingItem = new ClothingItem();
    private IBrowserFile selectedFile;
    private int currentUserId = 1; // לדוגמה – בהמשך לשלב האימות
    private bool isStep1Completed = false;
    private bool isComplete = false;

    private async Task HandleStep1Submit()
    {

        clothingItem.UserID = currentUserId;
        clothingItem.DateAdded = DateTime.Now;

        var response = await Http.PostAsJsonAsync("http://localhost:5177/api/clothingitems/addClothingItemAttributes", clothingItem);
        if (response.IsSuccessStatusCode)
        {
            clothingItem.ItemID = await response.Content.ReadFromJsonAsync<int>();
            isStep1Completed = true;
        }
        else
        {
            Console.WriteLine("Error adding clothing item attributes");
        }
    }

    private async Task HandleUploadImage()
    {
        if (selectedFile != null)
        {
            var content = new MultipartFormDataContent();
            content.Add(new StringContent(clothingItem.ItemID.ToString()), "ItemID");

            var fileContent = new StreamContent(selectedFile.OpenReadStream());
            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(selectedFile.ContentType);
            content.Add(fileContent, "ImageFile", selectedFile.Name); // ✅ הקפד שהשם בדיוק ככה!

            var response = await Http.PostAsync("http://localhost:5177/api/clothingitems/uploadImageForItem", content);

            if (response.IsSuccessStatusCode)
            {
                isComplete = true;
            }
            else
            {
                Console.WriteLine("Error uploading image");
            }
        }
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
    }
}
